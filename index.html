<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Modern Chess Score Sheet</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #2563eb;
            --bg-color: #f8fafc;
            --card-bg: #ffffff;
            --text-main: #1e293b;
            --border: #e2e8f0;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 20px 10px;
            display: flex;
            justify-content: center;
        }

        .container {
            width: 100%;
            max-width: 700px;
            background: var(--card-bg);
            border-radius: 16px;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            padding: 24px;
            position: relative;
        }

        h1 { margin: 0; color: var(--primary); font-size: 1.5rem; text-align: center; }
        .subtitle { font-size: 0.875rem; color: #64748b; text-align: center; margin-bottom: 20px; }

        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px; }
        .full-width { grid-column: span 2; }

        input, select {
            padding: 10px;
            border: 1px solid var(--border);
            border-radius: 8px;
            width: 100%;
            font-size: 16px; 
        }

        .score-container {
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .score-header, .move-row {
            display: grid;
            grid-template-columns: 40px 1fr 1fr;
            text-align: center;
        }
        
        .score-header { background: #1e293b; color: white; padding: 10px; font-weight: 600; }
        .move-row { border-bottom: 1px solid var(--border); }
        
        .move-num { background: #f1f5f9; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 0.8rem; }
        .move-input { border: none; text-align: center; font-weight: 500; border-radius: 0; }
        .move-input:focus { background: #eff6ff; }

        .actions { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 20px; }
        .btn {
            flex: 1; padding: 12px; border: none; border-radius: 8px;
            color: white; font-weight: 600; cursor: pointer; min-width: 120px;
        }
        .btn-add { background: var(--primary); }
        .btn-pgn { background: #334155; }
        .btn-save { background: #10b981; }

        /* --- MODAL STYLES --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.9); z-index: 9999;
            display: none; align-items: center; justify-content: center;
            flex-direction: column; padding: 20px;
        }
        
        .modal-content {
            background: white; padding: 15px; border-radius: 12px;
            max-width: 100%; max-height: 85vh; overflow-y: auto; text-align: center;
            display: flex; flex-direction: column; gap: 10px;
        }

        .modal-content img { 
            max-width: 100%; 
            height: auto; 
            border: 1px solid #ddd;
            -webkit-touch-callout: default !important;
            -webkit-user-select: auto !important;
            user-select: auto !important;
            pointer-events: auto !important;
        }

        .modal-msg { color: #333; font-weight: 600; font-size: 0.9rem; }
        
        .close-btn {
            padding: 10px; background: #ef4444; color: white; 
            border: none; border-radius: 6px; font-weight: bold; width: 100%;
        }

        .download-link-btn {
            display: block; padding: 10px; background: #2563eb; 
            color: white; text-decoration: none; border-radius: 6px; 
            font-weight: bold; font-size: 0.9rem; margin-top: 5px;
        }
    </style>
</head>
<body>

    <div class="container" id="printableArea">
        <h1>Chess Score Sheet</h1>
        <div class="subtitle">Official Electronic Record</div>

        <div class="info-grid">
            <input type="text" id="whitePlayer" placeholder="White Player">
            <input type="text" id="blackPlayer" placeholder="Black Player">
            <input type="text" id="eventName" class="full-width" placeholder="Tournament Name">
            <input type="date" id="eventDate">
            <select id="result">
                <option value="" disabled selected>Result</option>
                <option value="1-0">1-0</option>
                <option value="1/2-1/2">Draw</option>
                <option value="0-1">0-1</option>
            </select>
        </div>

        <div class="score-container">
            <div class="score-header">
                <div>#</div><div>White</div><div>Black</div>
            </div>
            <div id="movesList"></div>
        </div>

        <div class="actions" id="controlPanel">
            <button class="btn btn-add" onclick="addMoveRow()">+ Move</button>
            <button class="btn btn-pgn" onclick="forceCopyPGN()">Copy PGN</button>
            <button class="btn btn-save" onclick="generateImage()">Save Image</button>
        </div>
    </div>

    <div id="previewModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-msg">Long Press image to Save</div>
            
            <div id="modalImageContainer"></div>
            
            <a id="directDownloadLink" class="download-link-btn" href="#" download="chess_score.jpg">
                Download Image (Click)
            </a>

            <button class="close-btn" onclick="closeModal()">Close</button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <script>
        let moveCount = 1;
        const MOVES_CONTAINER = document.getElementById('movesList');

        window.onload = () => {
            document.getElementById('eventDate').value = new Date().toISOString().split('T')[0];
            for(let i = 0; i < 12; i++) addMoveRow(false);
        };

        function addMoveRow(focus = true) {
            const row = document.createElement('div');
            row.className = 'move-row';
            row.innerHTML = `
                <div class="move-num">${moveCount}</div>
                <input type="text" class="move-input" id="w${moveCount}">
                <input type="text" class="move-input" id="b${moveCount}">
            `;
            MOVES_CONTAINER.appendChild(row);
            if (focus) setTimeout(() => document.getElementById(`w${moveCount}`).focus(), 100);
            moveCount++;
        }

        // --- PGN COPY ---
        function forceCopyPGN() {
            let pgn = `[Event "${document.getElementById('eventName').value}"]\n`;
            pgn += `[White "${document.getElementById('whitePlayer').value}"]\n`;
            pgn += `[Black "${document.getElementById('blackPlayer').value}"]\n`;
            pgn += `[Result "${document.getElementById('result').value}"]\n\n`;

            for (let i = 1; i < moveCount; i++) {
                const w = document.getElementById(`w${i}`).value;
                const b = document.getElementById(`b${i}`).value;
                if (!w) break;
                pgn += `${i}. ${w} ${b} `;
            }

            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(pgn)
                    .then(() => alert("PGN Copied!"))
                    .catch(() => fallbackCopy(pgn));
            } else {
                fallbackCopy(pgn);
            }
        }

        function fallbackCopy(text) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed";
            textArea.style.left = "-9999px";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                document.execCommand('copy');
                alert("PGN Copied!");
            } catch (err) {
                alert("Copy failed.");
            }
            document.body.removeChild(textArea);
        }

        // --- IMAGE EXPORT (MOBILE WEBVIEW COMPATIBLE) ---
        async function generateImage() {
            const controls = document.getElementById('controlPanel');
            const container = document.getElementById('printableArea');
            
            controls.style.display = 'none';

            try {
                const canvas = await html2canvas(container, { 
                    scale: 2, 
                    useCORS: true, 
                    scrollY: -window.scrollY,
                    logging: false,
                    allowTaint: true
                });
                controls.style.display = 'flex';

                // Convert to base64 data URL (works everywhere)
                const dataURL = canvas.toDataURL('image/jpeg', 0.9);
                
                // 1. Try Native Share API (for mobile browsers)
                if (navigator.canShare) {
                    try {
                        const blob = await (await fetch(dataURL)).blob();
                        const file = new File([blob], "chess_score.jpg", { type: "image/jpeg" });
                        if (navigator.canShare({ files: [file] })) {
                            await navigator.share({ files: [file] });
                            return;
                        }
                    } catch (e) {
                        console.log("Share failed, trying other methods.");
                    }
                }

                // 2. Send to parent app (for WebView/iframe in mobile apps)
                if (window.ReactNativeWebView) {
                    // React Native WebView
                    const message = {
                        type: 'downloadImage',
                        data: dataURL,
                        filename: 'chess_score.jpg'
                    };
                    window.ReactNativeWebView.postMessage(JSON.stringify(message));
                    return;
                }

                if (window.Android && typeof window.Android.saveBase64Image === 'function') {
                    // Native Android WebView with JavaScript interface
                    window.Android.saveBase64Image(dataURL, 'chess_score.jpg');
                    return;
                }

                if (window.webkit && window.webkit.messageHandlers && window.webkit.messageHandlers.saveImage) {
                    // iOS WKWebView with message handler
                    window.webkit.messageHandlers.saveImage.postMessage({
                        data: dataURL,
                        filename: 'chess_score.jpg'
                    });
                    return;
                }

                if (window.parent !== window) {
                    // iframe in web app - send to parent
                    const message = {
                        type: 'downloadImage',
                        data: dataURL,
                        filename: 'chess_score.jpg'
                    };
                    window.parent.postMessage(message, '*');
                }

                // 3. Fallback: Show modal with image for long-press save
                showModal(dataURL);

            } catch (err) {
                console.error(err);
                controls.style.display = 'flex';
                alert("Error generating image.");
            }
        }

        function showModal(imageData) {
            const modal = document.getElementById('previewModal');
            const container = document.getElementById('modalImageContainer');
            const downloadBtn = document.getElementById('directDownloadLink');

            // Set image source
            container.innerHTML = `<img src="${imageData}" alt="Score Sheet" />`;
            
            // Set download button with data URL
            downloadBtn.href = imageData;

            modal.style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('previewModal').style.display = 'none';
        }
    </script>
</body>
</html>
